<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Subtitle - „É™„Ç¢„É´„Çø„Ç§„É†ÁøªË®≥</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            text-align: center; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee; 
            margin: 0; 
            padding: 15px;
            min-height: 100vh;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .setup-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 15px; 
            background: rgba(255, 255, 255, 0.03); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setup-box { 
            background: rgba(255, 255, 255, 0.05); 
            padding: 15px; 
            border-radius: 10px; 
            font-size: 0.9rem; 
            text-align: left;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setup-box:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .control-panel { 
            background: rgba(255, 255, 255, 0.05); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .btn { 
            padding: 12px 24px; 
            font-size: 1rem; 
            cursor: pointer; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            margin: 8px; 
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-green { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; }
        .btn-green:hover { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); }
        
        .btn-blue { background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); color: white; }
        .btn-blue:hover { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); }
        
        .btn-orange { 
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); 
            color: white; 
            width: 100%; 
            margin-top: 10px; 
            font-size: 0.9rem;
        }
        .btn-orange:hover { 
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-switch { 
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); 
            color: white; 
            width: 100%; 
            max-width: 400px; 
            font-size: 1.1rem;
            padding: 14px 28px;
        }
        .btn-switch:hover {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }
        
        textarea { 
            width: 100%; 
            height: 60px; 
            background: rgba(0, 0, 0, 0.3); 
            color: #0f0; 
            border: 1px solid rgba(85, 85, 85, 0.5); 
            padding: 8px; 
            font-size: 0.85rem; 
            font-family: 'Courier New', monospace; 
            resize: vertical;
            border-radius: 5px;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }
        
        .config-input { 
            width: 100%; 
            margin-bottom: 8px; 
            background: rgba(0, 0, 0, 0.3); 
            color: white; 
            border: 1px solid rgba(102, 102, 102, 0.5); 
            padding: 8px; 
            border-radius: 5px;
            transition: border-color 0.3s;
        }
        
        .config-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }
        
        .color-picker { 
            height: 40px; 
            width: 100%; 
            cursor: pointer; 
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            transition: transform 0.2s;
        }
        
        .color-picker:hover {
            transform: scale(1.05);
        }
        
        /* „É¨„É≥„Ç∏„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4facfe;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(79, 172, 254, 0.4);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #00f2fe;
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.6);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #4facfe;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(79, 172, 254, 0.4);
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            background: #00f2fe;
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.6);
        }
        
        input[type="range"]::-moz-range-track {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        #canvasContainer { 
            display: flex; 
            justify-content: center; 
            margin-top: 20px; 
            overflow-x: auto;
            padding: 10px;
        }
        
        #subtitleCanvas { 
            border: 2px solid rgba(102, 102, 102, 0.5); 
            background: transparent; 
            max-width: 100%; 
            height: auto;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        #status-bar { 
            font-size: 1.1rem; 
            font-weight: 600; 
            color: #4facfe; 
            margin: 10px 0;
            padding: 12px;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(79, 172, 254, 0.3);
        }
        
        #status-bar .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ddd; 
            font-size: 0.95rem;
        }
        
        .loading-indicator {
            display: inline-block;
            margin-left: 10px;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #4facfe;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .setup-container {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.4rem;
            }
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
<div class="container">
<div class="header">
    <h1>üéì „É™„Ç¢„É´„Çø„Ç§„É†Ë¨õÁæ©ÁøªË®≥„Ç∑„Çπ„ÉÜ„É†</h1>
    <p style="margin:0; color:#aaa; font-size:0.9rem;">ÊéàÊ•≠„ÇÑ„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÁøªË®≥„ÉªÂ≠óÂπïË°®Á§∫</p>
</div>

<div class="setup-container">
    <div class="setup-box">
        <label>1. Áî®Ë™ûÂ≠¶Áøí (PDF)</label>
        <input type="file" id="pdfUpload" accept="application/pdf" style="width:100%">
    </div>
    <div class="setup-box">
        <label>2. „Ç≠„Éº„ÉØ„Éº„Éâ„Éª„Éû„Ç§ËæûÊõ∏</label>
        <input type="text" id="manualKeywords" class="config-input" placeholder="Ë£úÊ≠£: AI, Gemini...">
        <textarea id="myDictionary" placeholder="ËæûÊõ∏: ‰∫∫Â∑•Áü•ËÉΩ:AI"></textarea>
        <button id="saveDictBtn" class="btn btn-orange">ËæûÊõ∏Á¢∫ÂÆö</button>
    </div>
    <div class="setup-box">
        <label>3. „Ç≠„É£„É≥„Éê„ÇπË®≠ÂÆö</label>
        <label style="font-size:0.85rem; margin-top:5px;">ÂπÖ(px)</label>
        <input type="number" id="cfgWidth" class="config-input" value="1900" min="800" max="3840">
        <label style="font-size:0.85rem; margin-top:5px;">È´ò„Åï(px)</label>
        <input type="number" id="cfgHeight" class="config-input" value="150" min="100" max="1080">
        <label style="font-size:0.85rem; margin-top:5px;">ÊñáÂ≠ó„Çµ„Ç§„Ç∫</label>
        <input type="number" id="cfgFontSize" class="config-input" value="50" min="20" max="200">
    </div>
    <div class="setup-box">
        <label>4. Ëâ≤Ë®≠ÂÆö</label>
        <label style="font-size:0.85rem; margin-top:5px;">ÊñáÂ≠óËâ≤</label>
        <input type="color" id="cfgTextColor" class="color-picker" value="#ffffff">
        <label style="font-size:0.85rem; margin-top:8px;">ËÉåÊôØËâ≤</label>
        <input type="color" id="cfgBgColor" class="color-picker" value="#000000">
        <label style="font-size:0.85rem; margin-top:8px;">ËÉåÊôØÈÄèÊòéÂ∫¶: <span id="bgOpacityValue">70</span>%</label>
        <input type="range" id="cfgBgOpacity" class="config-input" min="0" max="100" value="70" style="width:100%; padding:0;">
    </div>
</div>

<div class="control-panel">
    <div id="status-bar">
        <span class="status-indicator"></span>
        „É¢„Éº„Éâ: <span id="modeDisplay">Ê∫ñÂÇô‰∏≠</span>
        <span id="loadingIndicator" class="loading-indicator" style="display:none;"></span>
    </div>
    <button id="toggleLang" class="btn btn-switch">üîÑ Ë®ÄË™û„ÇíÂÖ•„ÇåÊõø„Åà„Çã</button>
    <br>
    <button id="startBtn" class="btn btn-green">üé§ Ë™çË≠òÈñãÂßã</button>
    <button id="pipBtn" class="btn btn-blue" style="display:none;">üì∫ Â≠óÂπï„ÇíÊµÆ„Åã„Åõ„Çã (PiP)</button>
</div>

<div id="canvasContainer">
    <canvas id="subtitleCanvas" width="1900" height="150"></canvas>
</div>
<video id="videoElement" autoplay playsinline muted style="display:none;"></video>
</div>

<script>
    // ==========================================
    // ‚Üì‚Üì „Åì„Åì„ÇíÊõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ ‚Üì‚Üì
    const MY_EMAIL = "yutairayu0924@gmail.com"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwPIYiOJu8Jn-Zke3wylZ2W4_fKMIkeDWGWiJV7LSLf70t9Q5-lacYj2pifcDDgXrYqyA/exec"; 
    // ==========================================

    const startBtn = document.getElementById('startBtn');
    const pipBtn = document.getElementById('pipBtn');
    const toggleLang = document.getElementById('toggleLang');
    const modeDisplay = document.getElementById('modeDisplay');
    const manualKeywords = document.getElementById('manualKeywords');
    const myDictionary = document.getElementById('myDictionary');
    const saveDictBtn = document.getElementById('saveDictBtn');
    const pdfUpload = document.getElementById('pdfUpload');
    const canvas = document.getElementById('subtitleCanvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('videoElement');

    // Ë®≠ÂÆöÁî®„Ç®„É¨„É°„É≥„Éà
    const cfgWidth = document.getElementById('cfgWidth');
    const cfgHeight = document.getElementById('cfgHeight');
    const cfgFontSize = document.getElementById('cfgFontSize');
    const cfgTextColor = document.getElementById('cfgTextColor');
    const cfgBgColor = document.getElementById('cfgBgColor');
    const cfgBgOpacity = document.getElementById('cfgBgOpacity');
    const bgOpacityValue = document.getElementById('bgOpacityValue');

    let recognition;
    let isJaToEn = true; 
    let currentTranslatedText = "Subtitle Preview"; // „Éó„É¨„Éì„É•„ÉºÁî®„Å´ÂàùÊúü„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•„Çå„Çã
    let currentInterimText = "";
    let glossary = [];
    let activeDictionary = [];
    let lastProcessedLength = 0;
    
    // ÁøªË®≥ÊîπÂñÑÁî®„ÅÆÂ§âÊï∞
    let translationCache = new Map(); // ÁøªË®≥„Ç≠„É£„ÉÉ„Ç∑„É•
    let translationQueue = []; // ÁøªË®≥„Ç≠„É•„Éº
    let isTranslating = false; // ÁøªË®≥‰∏≠„ÅÆ„Éï„É©„Ç∞
    let pendingTranslation = null; // ‰øùÁïô‰∏≠„ÅÆÁøªË®≥
    const CACHE_SIZE = 500; // „Ç≠„É£„ÉÉ„Ç∑„É•„Çµ„Ç§„Ç∫„ÅÆ‰∏äÈôê

    // Ë®≠ÂÆöÂ§âÊõ¥„ÅÆÁõ£Ë¶ñÔºàÂ§âÊõ¥„Åï„Çå„Åü„ÇâÂç≥ÂÜçÊèèÁîªÔºâ
    function updateConfig() {
        canvas.width = parseInt(cfgWidth.value) || 1900;
        canvas.height = parseInt(cfgHeight.value) || 150;
        draw();
    }
    cfgWidth.onchange = updateConfig;
    cfgHeight.onchange = updateConfig;
    cfgFontSize.onchange = draw;
    cfgTextColor.oninput = draw; // Ëâ≤„ÅØ„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÇÇÂèçÊò†
    cfgBgColor.oninput = draw;
    cfgBgOpacity.oninput = () => {
        bgOpacityValue.textContent = cfgBgOpacity.value;
        draw();
    };
    
    // 16ÈÄ≤Êï∞„Ç´„É©„Éº„Ç≥„Éº„Éâ„ÇíRGBAÂΩ¢Âºè„Å´Â§âÊèõ„Åô„ÇãÈñ¢Êï∞
    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    updateModeDisplay();

    saveDictBtn.onclick = () => {
        const lines = myDictionary.value.split('\n');
        activeDictionary = [];
        lines.forEach(line => {
            const [src, target] = line.split(/[:Ôºö]/);
            if (src && target) activeDictionary.push({ src: src.trim(), target: target.trim() });
        });
        showNotification(`ËæûÊõ∏Êõ¥Êñ∞ÂÆå‰∫Ü (${activeDictionary.length}‰ª∂)`);
        translationCache.clear(); // ËæûÊõ∏Êõ¥Êñ∞ÊôÇ„ÅØ„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
    };

    toggleLang.onclick = () => {
        isJaToEn = !isJaToEn;
        updateModeDisplay();
        if (recognition) {
            recognition.stop();
            recognition.lang = isJaToEn ? 'ja-JP' : 'en-US';
        }
    };

    function updateModeDisplay() {
        modeDisplay.innerText = isJaToEn ? "üáØüáµ Êó•Êú¨Ë™û ‚Üí üá∫üá∏ Ëã±Ë™û" : "üá∫üá∏ Ëã±Ë™û ‚Üí üáØüáµ Êó•Êú¨Ë™û";
    }

    pdfUpload.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function() {
            try {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(item => item.str).join(' ');
                }
                glossary = [...new Set([...glossary, ...(fullText.match(/[A-Z]{2,}|[a-zA-Z]{4,}|[\u4e00-\u9faf]{2,}/g) || [])])];
                showNotification(`PDFÂ≠¶ÁøíÂÆå‰∫ÜÔºÅ (${glossary.length}Ë™ûÂΩô)`);
            } catch (error) {
                console.error("PDFË™≠„ÅøËæº„Åø„Ç®„É©„Éº:", error);
                showNotification("PDFË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "error");
            }
        };
        reader.readAsArrayBuffer(file);
    };

    // ÈÄöÁü•Ë°®Á§∫Èñ¢Êï∞
    function showNotification(message, type = "success") {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.style.background = type === "error" 
            ? 'rgba(231, 76, 60, 0.95)' 
            : 'rgba(46, 204, 113, 0.95)';
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }

    // „Ç≠„É£„ÉÉ„Ç∑„É•ÁÆ°ÁêÜÈñ¢Êï∞
    function getCacheKey(text, source, target) {
        return `${source}_${target}_${text}`;
    }

    function addToCache(key, value) {
        if (translationCache.size >= CACHE_SIZE) {
            // ÊúÄ„ÇÇÂè§„ÅÑ„Ç®„É≥„Éà„É™„ÇíÂâäÈô§ÔºàLRUÁöÑ„Å™Âãï‰ΩúÔºâ
            const firstKey = translationCache.keys().next().value;
            translationCache.delete(firstKey);
        }
        translationCache.set(key, value);
    }

    // ÊîπÂñÑ„Åï„Çå„ÅüÁøªË®≥Èñ¢Êï∞Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•„ÄÅ„Ç≠„É•„Éº„Ç§„É≥„Ç∞„ÄÅ„É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„ÅçÔºâ
    async function translateText(text) {
        if (!text.trim()) return;
        
        // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÂâçÂá¶ÁêÜ
        let corrected = text.trim();
        const manual = manualKeywords.value.split(/[,„ÄÅ\s\n]+/).filter(w => w.length > 0);
        const activeGlossary = [...new Set([...glossary, ...manual])];
        activeGlossary.forEach(term => {
            if (term.length > 1 && corrected.toLowerCase().includes(term.toLowerCase())) {
                const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                corrected = corrected.replace(regex, term);
            }
        });

        const source = isJaToEn ? 'ja' : 'en';
        const target = isJaToEn ? 'en' : 'ja';
        const cacheKey = getCacheKey(corrected, source, target);

        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÉÅ„Çß„ÉÉ„ÇØ
        if (translationCache.has(cacheKey)) {
            let translated = translationCache.get(cacheKey);
            // ËæûÊõ∏ÈÅ©Áî®
            activeDictionary.forEach(pair => {
                const regex = new RegExp(pair.src.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                translated = translated.replace(regex, pair.target);
            });
            currentTranslatedText = translated;
            draw();
            return;
        }

        // „Ç≠„É•„Éº„Ç§„É≥„Ç∞Âá¶ÁêÜ
        if (isTranslating) {
            pendingTranslation = { corrected, source, target, cacheKey };
            return;
        }

        await performTranslation(corrected, source, target, cacheKey);
    }

    // ÂÆüÈöõ„ÅÆÁøªË®≥ÂÆüË°åÈñ¢Êï∞
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    async function performTranslation(corrected, source, target, cacheKey, retryCount = 0) {
        isTranslating = true;
        loadingIndicator.style.display = 'inline-block';
        const apiUrl = `${GAS_URL}?text=${encodeURIComponent(corrected)}&source=${source}&target=${target}`;
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10Áßí„Çø„Ç§„É†„Ç¢„Ç¶„Éà
            
            const res = await fetch(apiUrl, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const data = await res.json();
            let translated = data.text || data.translatedText || corrected;
            
            // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
            addToCache(cacheKey, translated);
            
            // ËæûÊõ∏ÈÅ©Áî®
            activeDictionary.forEach(pair => {
                const regex = new RegExp(pair.src.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                translated = translated.replace(regex, pair.target);
            });
            
            currentTranslatedText = translated;
            draw();
            loadingIndicator.style.display = 'none';
            
            // ‰øùÁïô‰∏≠„ÅÆÁøªË®≥„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜ
            if (pendingTranslation) {
                const pending = pendingTranslation;
                pendingTranslation = null;
                await performTranslation(pending.corrected, pending.source, pending.target, pending.cacheKey);
            } else {
                isTranslating = false;
            }
        } catch (e) {
            console.error("ÁøªË®≥„Ç®„É©„Éº:", e);
            loadingIndicator.style.display = 'none';
            isTranslating = false;
            
            // „É™„Éà„É©„Ç§ÔºàÊúÄÂ§ß2ÂõûÔºâ
            if (retryCount < 2 && e.name !== 'AbortError') {
                await new Promise(resolve => setTimeout(resolve, 500 * (retryCount + 1)));
                await performTranslation(corrected, source, target, cacheKey, retryCount + 1);
            } else {
                // „Ç®„É©„ÉºÊôÇ„ÅØÂÖÉ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíË°®Á§∫
                currentTranslatedText = corrected;
                draw();
            }
        }
    }

    function draw() {
        // ËÉåÊôØ„Çí„ÇØ„É™„Ç¢ÔºàÈÄèÊòé„Å´„Åô„ÇãÔºâ
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ËÉåÊôØËâ≤Ë®≠ÂÆöÔºàÂçäÈÄèÊòéÔºâ
        const opacity = parseFloat(cfgBgOpacity.value) / 100;
        ctx.fillStyle = hexToRgba(cfgBgColor.value, opacity);
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Ë™çË≠ò‰∏≠„ÉÜ„Ç≠„Çπ„ÉàÔºàËâ≤„ÅØÊñáÂ≠óËâ≤„Çà„ÇäÂ∞ë„ÅóËñÑ„Åè„Åô„ÇãÂá¶ÁêÜ„ÇíÂÖ•„Çå„Çã„Åã„ÄÅÂõ∫ÂÆö„Ç∞„É¨„ÉºÔºâ
        if (currentInterimText) {
            ctx.fillStyle = '#888888'; 
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(currentInterimText, 10, 15);
        }

        const maxWidth = canvas.width - 50;
        // Âü∫Êú¨„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆöÂÄ§„Åã„ÇâÂèñÂæó
        let baseSize = parseInt(cfgFontSize.value) || 50;
        let fontSize = baseSize; 
        let lineHeight = baseSize * 1.2;

        // Èï∑ÊñáÊôÇ„ÅÆËá™ÂãïÁ∏ÆÂ∞è„É≠„Ç∏„ÉÉ„ÇØ
        if (currentTranslatedText.length > 100) { fontSize = baseSize * 0.6; lineHeight = fontSize * 1.2; }
        else if (currentTranslatedText.length > 60) { fontSize = baseSize * 0.8; lineHeight = fontSize * 1.2; }

        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.fillStyle = cfgTextColor.value; // ÊñáÂ≠óËâ≤Ë®≠ÂÆö
        ctx.textAlign = 'center';

        let words = currentTranslatedText.split('');
        let lines = [];
        let currentLine = words[0] || "";

        for (let i = 1; i < words.length; i++) {
            let width = ctx.measureText(currentLine + words[i]).width;
            if (width < maxWidth) {
                currentLine += words[i];
            } else {
                lines.push(currentLine);
                currentLine = words[i];
            }
        }
        lines.push(currentLine);

        let totalHeight = lines.length * lineHeight;
        let startY = (canvas.height - totalHeight) / 2 + (lineHeight / 2) - 5; 

        for (let i = 0; i < lines.length; i++) {
            ctx.fillText(lines[i], canvas.width / 2, startY + (i * lineHeight));
        }
    }

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = async (event) => {
            let interim = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                let transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    // ÊúÄÁµÇÁµêÊûú„ÅØÂç≥Â∫ß„Å´ÁøªË®≥
                    translateText(transcript);
                    lastProcessedLength = 0;
                } else {
                    interim = transcript;
                    // ÈÉ®ÂàÜÁøªË®≥„ÅÆÈñæÂÄ§„ÇíË®ÄË™û„Å´Âøú„Åò„Å¶Ë™øÊï¥Ôºà„Çà„ÇäÂäπÁéáÁöÑ„Å´Ôºâ
                    const threshold = isJaToEn ? 15 : 50; // ÈñæÂÄ§„Çí‰∏ã„Åí„Å¶„Çà„ÇäÈ†ªÁπÅ„Å´ÁøªË®≥
                    if (interim.length - lastProcessedLength > threshold) {
                        const chunk = interim.substring(lastProcessedLength).trim();
                        if (chunk.length > 3) { // Áü≠„Åô„Åé„Çã„ÉÜ„Ç≠„Çπ„Éà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                            translateText(chunk);
                            lastProcessedLength = interim.length;
                        }
                    }
                }
            }
            currentInterimText = interim;
            draw();
        };
        recognition.onend = () => { recognition.start(); };
    }

    startBtn.onclick = () => {
        recognition.lang = isJaToEn ? 'ja-JP' : 'en-US';
        recognition.start();
        // „Éó„É¨„Éì„É•„ÉºÊñáÂ≠ó„ÇíÊ∂à„Åô
        if(currentTranslatedText === "Subtitle Preview") currentTranslatedText = ""; 
        startBtn.style.display = 'none';
        pipBtn.style.display = 'inline-block';
        video.srcObject = canvas.captureStream(10);
        video.play();
        draw();
    };
    pipBtn.onclick = () => video.requestPictureInPicture();
    
    // ÂàùÊúüÊèèÁîªÔºà„Éó„É¨„Éì„É•„ÉºÔºâ
    draw();
</script>
</body>
</html>