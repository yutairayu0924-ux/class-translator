<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Fixed Subtitle Tool</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #2c3e50; color: white; padding: 20px; }
        .controls { background: #34495e; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .btn { padding: 10px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; margin: 5px; }
        #startBtn { background: #27ae60; color: white; }
        #pipBtn { background: #2980b9; color: white; }
        #subtitleCanvas { border: 2px solid white; background: black; width: 100%; max-width: 600px; }
        #debugLog { background: #000; color: #0f0; padding: 10px; height: 100px; overflow-y: scroll; font-size: 0.8rem; text-align: left; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>Subtitle Overlay V2.1</h2>

    <div class="controls">
        <select id="langMode">
            <option value="ja|en">日本語 → 英語</option>
            <option value="en|ja">英語 → 日本語</option>
        </select>
        <button id="startBtn" class="btn">1. マイク開始</button>
        <button id="pipBtn" class="btn" style="display:none;">2. 字幕を浮かせる</button>
    </div>

    <canvas id="subtitleCanvas" width="800" height="150"></canvas>
    <video id="videoElement" autoplay playsinline muted style="display:none;"></video>

    <div id="debugLog">【ログ】ここに動作状況が表示されます...</div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const pipBtn = document.getElementById('pipBtn');
        const langMode = document.getElementById('langMode');
        const canvas = document.getElementById('subtitleCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('videoElement');
        const log = document.getElementById('debugLog');

        let recognition;

        function addLog(msg) {
            log.innerHTML += `<div>${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function drawSubtitle(text) {
            // 背景を黒で塗りつぶし
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // 文字を書く
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(text, canvas.width / 2, 90);
        }

        // 初期表示
        drawSubtitle("準備完了：開始を押してください");

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => addLog("✔ 音声認識が起動しました");
            recognition.onerror = (e) => addLog("❌ エラー: " + e.error);
            
            recognition.onresult = async (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // 認識中の声をキャンバスに出す
                if (interimTranscript) {
                    drawSubtitle(interimTranscript);
                }

                // 確定したら翻訳して出す
                if (finalTranscript) {
                    addLog("認識確定: " + finalTranscript);
                    const [source, target] = langMode.value.split('|');
                    try {
                        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(finalTranscript)}&langpair=${source}|${target}`);
                        const data = await res.json();
                        const translatedText = data.responseData.translatedText;
                        addLog("翻訳成功: " + translatedText);
                        drawSubtitle(translatedText);
                    } catch (e) {
                        addLog("❌ 翻訳失敗");
                    }
                }
            };
        } else {
            addLog("❌ お使いのブラウザは音声認識に対応していません。Chromeをお使いください。");
        }

        startBtn.onclick = () => {
            const [source, target] = langMode.value.split('|');
            recognition.lang = (source === 'ja') ? 'ja-JP' : 'en-US';
            
            recognition.start();
            startBtn.style.display = 'none';
            pipBtn.style.display = 'inline-block';

            // CanvasをVideoに接続して再生開始
            const stream = canvas.captureStream(10); // 10fpsで更新
            video.srcObject = stream;
            video.play(); // これが重要！
        };

        pipBtn.onclick = () => {
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
            } else {
                video.requestPictureInPicture().catch(e => addLog("❌ PiP失敗: " + e));
            }
        };
    </script>
</body>
</html>