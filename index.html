<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Subtitle - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¿»è¨³</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            margin: 0;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            transition: all 0.5s ease;
        }

        /* ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        body.presentation-mode {
            background: transparent;
            /* èƒŒæ™¯ã‚’é€æ˜ã«ï¼ˆOSè¨­å®šã‚„é€éã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã¯ãªã‚‰ãªã„ãŒã€æ„å›³ã¨ã—ã¦ï¼‰ */
            padding: 0;
            overflow: hidden;
        }

        body.presentation-mode .header,
        body.presentation-mode .setup-container,
        body.presentation-mode .control-panel {
            display: none !important;
        }

        body.presentation-mode .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            /* ä¸‹å¯„ã› */
            padding-bottom: 50px;
        }

        body.presentation-mode #canvasContainer {
            margin: 0;
            padding: 0;
            width: 100%;
            background: transparent;
        }

        body.presentation-mode #subtitleCanvas {
            max-width: 100%;
        }

        /* ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ¢ãƒ¼ãƒ‰å¾©å¸°ãƒœã‚¿ãƒ³ */
        #exitPresBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 30px;
            cursor: pointer;
            display: none;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        body.presentation-mode:hover #exitPresBtn {
            opacity: 1;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ddd;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .setup-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setup-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            text-align: left;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setup-box:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .btn {
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            margin: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-green {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-green:hover {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        }

        .btn-red {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
        }

        .btn-red:hover {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-blue {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            color: white;
        }

        .btn-blue:hover {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-orange {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            color: white;
            width: 100%;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .btn-orange:hover {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-switch {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            width: 100%;
            max-width: 400px;
            font-size: 1.1rem;
            padding: 14px 28px;
        }

        .btn-switch:hover {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        textarea {
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            color: #0f0;
            border: 1px solid rgba(85, 85, 85, 0.5);
            padding: 8px;
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            resize: vertical;
            border-radius: 5px;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .config-input {
            width: 100%;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(102, 102, 102, 0.5);
            padding: 8px;
            border-radius: 5px;
            transition: border-color 0.3s;
        }

        .config-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .color-picker {
            height: 40px;
            width: 100%;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            transition: transform 0.2s;
        }

        .color-picker:hover {
            transform: scale(1.05);
        }

        /* ãƒ¬ãƒ³ã‚¸ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4facfe;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(79, 172, 254, 0.4);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #00f2fe;
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.6);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #4facfe;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(79, 172, 254, 0.4);
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: #00f2fe;
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.6);
        }

        input[type="range"]::-moz-range-track {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        #canvasContainer {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            overflow-x: auto;
            padding: 10px;
        }

        #subtitleCanvas {
            border: 2px solid rgba(102, 102, 102, 0.5);
            background: transparent;
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        #subtitleCanvas.no-frame {
            border: none;
            box-shadow: none;
        }

        #status-bar {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4facfe;
            margin: 10px 0;
            padding: 12px;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(79, 172, 254, 0.3);
        }

        #status-bar .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ddd;
            font-size: 0.95rem;
        }

        .loading-indicator {
            display: inline-block;
            margin-left: 10px;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #4facfe;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .setup-container {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.4rem;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¬›ç¾©ç¿»è¨³ã‚·ã‚¹ãƒ†ãƒ </h1>
                    <p style="margin:0; color:#aaa; font-size:0.9rem;">æˆæ¥­ã‚„ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¿»è¨³ãƒ»å­—å¹•è¡¨ç¤º</p>
                </div>
                <div style="display:flex; gap:10px;">
                    <button id="presModeBtn" class="settings-btn"
                        style="background:rgba(79, 172, 254, 0.2); border-color:#4facfe;">ğŸ–¥ ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ¢ãƒ¼ãƒ‰</button>
                    <button id="toggleSettingsBtn" class="settings-btn">âš™ï¸ è¨­å®šã‚’éš ã™</button>
                </div>
            </div>
        </div>

        <button id="exitPresBtn">â†© é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>

        <div class="setup-container" id="setupContainer">
            <div class="setup-box">
                <label>0. ã‚·ã‚¹ãƒ†ãƒ è¨­å®š (å¿…é ˆ)</label>
                <label style="font-size:0.8rem; color:#aaa;">GAS URL</label>
                <input type="password" id="cfgGasUrl" class="config-input" placeholder="https://script.google.com/..."
                    onfocus="this.type='text'" onblur="this.type='password'">
                <label style="font-size:0.8rem; color:#aaa;">Email (ãƒ­ã‚°ç”¨)</label>
                <input type="text" id="cfgEmail" class="config-input" placeholder="example@gmail.com">
            </div>
            <div class="setup-box">
                <label>1. ç”¨èªå­¦ç¿’ (PDF)</label>
                <input type="file" id="pdfUpload" accept="application/pdf" style="width:100%">
            </div>
            <div class="setup-box">
                <label>2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒã‚¤è¾æ›¸</label>
                <input type="text" id="manualKeywords" class="config-input" placeholder="è£œæ­£: AI, Gemini...">
                <textarea id="myDictionary" placeholder="è¾æ›¸: äººå·¥çŸ¥èƒ½:AI"></textarea>
                <button id="saveDictBtn" class="btn btn-orange">è¾æ›¸ç¢ºå®š</button>
            </div>
            <div class="setup-box">
                <label>3. ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š</label>
                <label style="font-size:0.85rem; margin-top:5px;">å¹…(px)</label>
                <input type="number" id="cfgWidth" class="config-input" value="1900" min="800" max="3840">
                <label style="font-size:0.85rem; margin-top:5px;">é«˜ã•(px)</label>
                <input type="number" id="cfgHeight" class="config-input" value="150" min="100" max="1080">
                <label style="font-size:0.85rem; margin-top:5px;">æ–‡å­—ã‚µã‚¤ã‚º</label>
                <input type="number" id="cfgFontSize" class="config-input" value="50" min="20" max="200">
                <label style="display: items-center; margin-top: 8px; font-size: 0.9rem; cursor: pointer;">
                    <input type="checkbox" id="cfgShowFrame" checked style="margin-right: 5px;"> æ ç·šãƒ»å½±ã‚’è¡¨ç¤º
                </label>
            </div>
            <div class="setup-box">
                <label>4. è‰²è¨­å®š</label>
                <label style="font-size:0.85rem; margin-top:5px;">æ–‡å­—è‰²</label>
                <input type="color" id="cfgTextColor" class="color-picker" value="#ffffff">
                <label style="font-size:0.85rem; margin-top:8px;">èƒŒæ™¯è‰²</label>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="color" id="cfgBgColor" class="color-picker" value="#000000" style="flex:1;">
                    <button id="btnTransparent"
                        style="padding:5px 10px; font-size:0.8rem; border-radius:5px; border:1px solid #555; background:rgba(255,255,255,0.1); color:#fff; cursor:pointer;">é€æ˜</button>
                </div>
                <label style="font-size:0.85rem; margin-top:8px;">èƒŒæ™¯é€æ˜åº¦: <span id="bgOpacityValue">70</span>%</label>
                <input type="range" id="cfgBgOpacity" class="config-input" min="0" max="100" value="70"
                    style="width:100%; padding:0;">
            </div>
        </div>

        <div class="control-panel">
            <div id="status-bar">
                <span class="status-indicator"></span>
                ãƒ¢ãƒ¼ãƒ‰: <span id="modeDisplay">æº–å‚™ä¸­</span>
                <span id="loadingIndicator" class="loading-indicator" style="display:none;"></span>
            </div>
            <button id="toggleLang" class="btn btn-switch">ğŸ”„ è¨€èªã‚’å…¥ã‚Œæ›¿ãˆã‚‹</button>
            <br>
            <br>
            <button id="startBtn" class="btn btn-green">ğŸ¤ èªè­˜é–‹å§‹</button>
            <button id="pipBtn" class="btn btn-blue">ğŸ“º å­—å¹•ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º (PiP)</button>
        </div>

        <div id="canvasContainer">
            <canvas id="subtitleCanvas" width="1900" height="150"></canvas>
        </div>
        <video id="videoElement" autoplay playsinline muted style="display:none;"></video>
    </div>

    <script>
        // ==========================================
        // è¨­å®šã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™
        // ==========================================

        const startBtn = document.getElementById('startBtn');
        const pipBtn = document.getElementById('pipBtn');
        const toggleLang = document.getElementById('toggleLang');
        const modeDisplay = document.getElementById('modeDisplay');
        const manualKeywords = document.getElementById('manualKeywords');
        const myDictionary = document.getElementById('myDictionary');
        const saveDictBtn = document.getElementById('saveDictBtn');
        const pdfUpload = document.getElementById('pdfUpload');
        const canvas = document.getElementById('subtitleCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('videoElement');

        // è¨­å®šç”¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ
        const cfgWidth = document.getElementById('cfgWidth');
        const cfgHeight = document.getElementById('cfgHeight');
        const cfgFontSize = document.getElementById('cfgFontSize');
        const cfgTextColor = document.getElementById('cfgTextColor');
        const cfgBgColor = document.getElementById('cfgBgColor');
        const cfgBgOpacity = document.getElementById('cfgBgOpacity');
        const bgOpacityValue = document.getElementById('bgOpacityValue');
        const cfgGasUrl = document.getElementById('cfgGasUrl');
        const cfgEmail = document.getElementById('cfgEmail');
        const cfgShowFrame = document.getElementById('cfgShowFrame');
        const btnTransparent = document.getElementById('btnTransparent');
        const setupContainer = document.getElementById('setupContainer');
        const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
        const presModeBtn = document.getElementById('presModeBtn');
        const exitPresBtn = document.getElementById('exitPresBtn');

        // UIåˆ¶å¾¡
        let isSettingsVisible = true;
        toggleSettingsBtn.onclick = () => {
            isSettingsVisible = !isSettingsVisible;
            setupContainer.style.display = isSettingsVisible ? 'grid' : 'none';
            toggleSettingsBtn.textContent = isSettingsVisible ? 'âš™ï¸ è¨­å®šã‚’éš ã™' : 'âš™ï¸ è¨­å®šã‚’è¡¨ç¤º';
        };

        // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        presModeBtn.onclick = () => {
            document.body.classList.add('presentation-mode');
            exitPresBtn.style.display = 'block';
            showNotification("ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼ã§ã€Œæˆ»ã‚‹ãƒœã‚¿ãƒ³ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™");
        };

        exitPresBtn.onclick = () => {
            document.body.classList.remove('presentation-mode');
            exitPresBtn.style.display = 'none';
        };

        let recognition;
        let isJaToEn = true;
        let currentTranslatedText = "Subtitle Preview"; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã«åˆæœŸãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥ã‚Œã‚‹
        let currentInterimText = "";
        let glossary = [];
        let activeDictionary = [];
        let lastProcessedLength = 0;

        // ç¿»è¨³æ”¹å–„ç”¨ã®å¤‰æ•°
        let translationCache = new Map(); // ç¿»è¨³ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let translationQueue = []; // ç¿»è¨³ã‚­ãƒ¥ãƒ¼
        let isTranslating = false; // ç¿»è¨³ä¸­ã®ãƒ•ãƒ©ã‚°
        let pendingTranslation = null; // ä¿ç•™ä¸­ã®ç¿»è¨³
        const CACHE_SIZE = 500; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã®ä¸Šé™

        // è¨­å®šå¤‰æ›´ã®ç›£è¦–ï¼ˆå¤‰æ›´ã•ã‚ŒãŸã‚‰å³å†æç”»ï¼†ä¿å­˜ï¼‰
        function updateConfig() {
            canvas.width = parseInt(cfgWidth.value) || 1900;
            canvas.height = parseInt(cfgHeight.value) || 150;
            draw();
            saveSettings();
        }
        cfgWidth.onchange = updateConfig;
        cfgHeight.onchange = updateConfig;
        cfgFontSize.onchange = () => { draw(); saveSettings(); };
        cfgTextColor.oninput = () => { draw(); saveSettings(); };
        cfgBgColor.oninput = () => { draw(); saveSettings(); };
        cfgBgOpacity.oninput = () => {
            bgOpacityValue.textContent = cfgBgOpacity.value;
            draw();
            saveSettings();
        };

        // é€æ˜ãƒœã‚¿ãƒ³
        btnTransparent.onclick = () => {
            cfgBgOpacity.value = 0;
            bgOpacityValue.textContent = "0";
            draw();
            saveSettings();
        };

        // æ ç·šè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        cfgShowFrame.onchange = () => {
            if (cfgShowFrame.checked) {
                canvas.classList.remove('no-frame');
            } else {
                canvas.classList.add('no-frame');
            }
            saveSettings();
        };

        cfgGasUrl.onchange = saveSettings;
        cfgEmail.onchange = saveSettings;
        manualKeywords.onchange = saveSettings;

        // 16é€²æ•°ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’RGBAå½¢å¼ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        updateModeDisplay();

        saveDictBtn.onclick = () => {
            const lines = myDictionary.value.split('\n');
            activeDictionary = [];
            lines.forEach(line => {
                const [src, target] = line.split(/[:ï¼š]/);
                if (src && target) activeDictionary.push({ src: src.trim(), target: target.trim() });
            });
            showNotification(`è¾æ›¸æ›´æ–°å®Œäº† (${activeDictionary.length}ä»¶)`);
            translationCache.clear(); // è¾æ›¸æ›´æ–°æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
            saveSettings();
        };

        toggleLang.onclick = () => {
            isJaToEn = !isJaToEn;
            updateModeDisplay();
            if (recognition) {
                recognition.stop();
                recognition.lang = isJaToEn ? 'ja-JP' : 'en-US';
            }
        };

        function updateModeDisplay() {
            modeDisplay.innerText = isJaToEn ? "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª â†’ ğŸ‡ºğŸ‡¸ è‹±èª" : "ğŸ‡ºğŸ‡¸ è‹±èª â†’ ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª";
        }

        pdfUpload.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function () {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        fullText += content.items.map(item => item.str).join(' ');
                    }
                    glossary = [...new Set([...glossary, ...(fullText.match(/[A-Z]{2,}|[a-zA-Z]{4,}|[\u4e00-\u9faf]{2,}/g) || [])])];
                    showNotification(`PDFå­¦ç¿’å®Œäº†ï¼ (${glossary.length}èªå½™)`);
                } catch (error) {
                    console.error("PDFèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                    showNotification("PDFèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // é€šçŸ¥è¡¨ç¤ºé–¢æ•°
        function showNotification(message, type = "success") {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === "error"
                ? 'rgba(231, 76, 60, 0.95)'
                : 'rgba(46, 204, 113, 0.95)';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†é–¢æ•°
        function getCacheKey(text, source, target) {
            return `${source}_${target}_${text}`;
        }

        function addToCache(key, value) {
            if (translationCache.size >= CACHE_SIZE) {
                // æœ€ã‚‚å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤ï¼ˆLRUçš„ãªå‹•ä½œï¼‰
                const firstKey = translationCache.keys().next().value;
                translationCache.delete(firstKey);
            }
            translationCache.set(key, value);
        }

        // æ”¹å–„ã•ã‚ŒãŸç¿»è¨³é–¢æ•°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
        async function translateText(text) {
            if (!text.trim()) return;

            // ãƒ†ã‚­ã‚¹ãƒˆã®å‰å‡¦ç†
            let corrected = text.trim();
            const manual = manualKeywords.value.split(/[,ã€\s\n]+/).filter(w => w.length > 0);
            const activeGlossary = [...new Set([...glossary, ...manual])];
            activeGlossary.forEach(term => {
                if (term.length > 1 && corrected.toLowerCase().includes(term.toLowerCase())) {
                    const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    corrected = corrected.replace(regex, term);
                }
            });

            const source = isJaToEn ? 'ja' : 'en';
            const target = isJaToEn ? 'en' : 'ja';
            const cacheKey = getCacheKey(corrected, source, target);

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
            if (translationCache.has(cacheKey)) {
                let translated = translationCache.get(cacheKey);
                // è¾æ›¸é©ç”¨
                activeDictionary.forEach(pair => {
                    const regex = new RegExp(pair.src.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    translated = translated.replace(regex, pair.target);
                });
                currentTranslatedText = translated;
                draw();
                return;
            }

            // ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°å‡¦ç†
            if (isTranslating) {
                pendingTranslation = { corrected, source, target, cacheKey };
                return;
            }

            await performTranslation(corrected, source, target, cacheKey);
        }

        // å®Ÿéš›ã®ç¿»è¨³å®Ÿè¡Œé–¢æ•°
        const loadingIndicator = document.getElementById('loadingIndicator');

        async function performTranslation(corrected, source, target, cacheKey, retryCount = 0) {
            isTranslating = true;
            loadingIndicator.style.display = 'inline-block';

            const gasUrl = cfgGasUrl.value.trim();
            if (!gasUrl) {
                showNotification("GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
                isTranslating = false;
                loadingIndicator.style.display = 'none';
                return;
            }

            const email = cfgEmail.value.trim() || 'anonymous';
            const apiUrl = `${gasUrl}?text=${encodeURIComponent(corrected)}&source=${source}&target=${target}&email=${encodeURIComponent(email)}`;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

                const res = await fetch(apiUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const data = await res.json();
                let translated = data.text || data.translatedText || corrected;

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                addToCache(cacheKey, translated);

                // è¾æ›¸é©ç”¨
                activeDictionary.forEach(pair => {
                    const regex = new RegExp(pair.src.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    translated = translated.replace(regex, pair.target);
                });

                currentTranslatedText = translated;
                draw();
                loadingIndicator.style.display = 'none';

                // ä¿ç•™ä¸­ã®ç¿»è¨³ãŒã‚ã‚Œã°å‡¦ç†
                if (pendingTranslation) {
                    const pending = pendingTranslation;
                    pendingTranslation = null;
                    await performTranslation(pending.corrected, pending.source, pending.target, pending.cacheKey);
                } else {
                    isTranslating = false;
                }
            } catch (e) {
                console.error("ç¿»è¨³ã‚¨ãƒ©ãƒ¼:", e);
                loadingIndicator.style.display = 'none';
                isTranslating = false;

                // ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§2å›ï¼‰
                if (retryCount < 2 && e.name !== 'AbortError') {
                    await new Promise(resolve => setTimeout(resolve, 500 * (retryCount + 1)));
                    await performTranslation(corrected, source, target, cacheKey, retryCount + 1);
                } else {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
                    currentTranslatedText = corrected;
                    draw();
                }
            }
        }

        function draw() {
            // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢ï¼ˆé€æ˜ã«ã™ã‚‹ï¼‰
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // èƒŒæ™¯è‰²è¨­å®šï¼ˆåŠé€æ˜ï¼‰
            const opacity = parseFloat(cfgBgOpacity.value) / 100;
            ctx.fillStyle = hexToRgba(cfgBgColor.value, opacity);
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // èªè­˜ä¸­ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè‰²ã¯æ–‡å­—è‰²ã‚ˆã‚Šå°‘ã—è–„ãã™ã‚‹å‡¦ç†ã‚’å…¥ã‚Œã‚‹ã‹ã€å›ºå®šã‚°ãƒ¬ãƒ¼ï¼‰
            if (currentInterimText) {
                ctx.fillStyle = '#888888';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(currentInterimText, 10, 15);
            }

            // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¨­å®šï¼ˆå·¦å³80pxã€ä¸Šä¸‹20pxï¼‰
            const paddingX = 80;
            const paddingY = 20;
            const maxWidth = canvas.width - (paddingX * 2);
            const maxHeight = canvas.height - (paddingY * 2);

            // åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’è¨­å®šå€¤ã‹ã‚‰å–å¾—
            let baseSize = parseInt(cfgFontSize.value) || 50;
            let fontSize = baseSize;
            let lineHeight;
            let lines = [];

            // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å‹•çš„ã«èª¿æ•´ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãŒåã¾ã‚‹ã¾ã§ç¸®å°ï¼‰
            let attempts = 0;
            const maxAttempts = 20;

            while (attempts < maxAttempts) {
                lineHeight = fontSize * 1.2;
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.textAlign = 'center';

                // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–‡å­—å˜ä½ã§åˆ†å‰²ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªä¸¡å¯¾å¿œï¼‰
                let chars = currentTranslatedText.split('');
                lines = [];
                let currentLine = chars[0] || "";

                // æ”¹è¡Œå‡¦ç†ï¼ˆæ–‡å­—å˜ä½ã€ãŸã ã—é•·ã„å˜èªã¯å¼·åˆ¶æ”¹è¡Œï¼‰
                for (let i = 1; i < chars.length; i++) {
                    const testLine = currentLine + chars[i];
                    const measuredWidth = ctx.measureText(testLine).width;

                    if (measuredWidth < maxWidth) {
                        currentLine = testLine;
                    } else {
                        // ç¾åœ¨ã®è¡ŒãŒç©ºã§ãªã„å ´åˆã®ã¿è¿½åŠ 
                        if (currentLine.trim()) {
                            lines.push(currentLine);
                        }
                        currentLine = chars[i];

                        // å˜ä¸€æ–‡å­—ãŒmaxWidthã‚’è¶…ãˆã‚‹å ´åˆã¯å¼·åˆ¶çš„ã«ç¸®å°ï¼ˆéå¸¸ã«é•·ã„URLãªã©ï¼‰
                        if (ctx.measureText(chars[i]).width > maxWidth) {
                            fontSize = Math.max(fontSize * 0.8, 12);
                            attempts++;
                            break;
                        }
                    }
                }

                // æœ€å¾Œã®è¡Œã‚’è¿½åŠ 
                if (currentLine.trim()) {
                    lines.push(currentLine);
                }

                // é«˜ã•ãƒã‚§ãƒƒã‚¯
                const totalHeight = lines.length * lineHeight;

                if (totalHeight <= maxHeight) {
                    // åã¾ã£ãŸã®ã§çµ‚äº†
                    break;
                } else {
                    // é«˜ã•ãŒè¶³ã‚Šãªã„ã®ã§ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¸®å°
                    fontSize = fontSize * 0.85;
                    attempts++;
                }
            }

            // æœ€çµ‚çš„ãªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.fillStyle = cfgTextColor.value;
            ctx.textAlign = 'center';

            // å‚ç›´æ–¹å‘ã®ä¸­å¤®æƒãˆ
            const totalHeight = lines.length * lineHeight;
            let startY = (canvas.height - totalHeight) / 2 + (lineHeight / 2);

            // ãƒ†ã‚­ã‚¹ãƒˆæç”»ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ã®ãŸã‚ã€é«˜ã•ç¯„å›²å†…ã®ã¿æç”»ï¼‰
            for (let i = 0; i < lines.length; i++) {
                const yPos = startY + (i * lineHeight);
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ç¯„å›²å†…ã«åã¾ã‚‹å ´åˆã®ã¿æç”»
                if (yPos >= paddingY && yPos <= canvas.height - paddingY) {
                    // å„ãƒ©ã‚¤ãƒ³ãŒmaxWidthã‚’è¶…ãˆãªã„ã“ã¨ã‚’ç¢ºèª
                    const lineWidth = ctx.measureText(lines[i]).width;
                    if (lineWidth <= maxWidth) {
                        ctx.fillText(lines[i], canvas.width / 2, yPos);
                    } else {
                        // ä¸‡ãŒä¸€ã¯ã¿å‡ºã™å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’çœç•¥
                        ctx.fillText(lines[i].substring(0, Math.floor(lines[i].length * 0.9)) + '...', canvas.width / 2, yPos);
                    }
                }
            }
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = async (event) => {
                let interim = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    let transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        // æœ€çµ‚çµæœã¯å³åº§ã«ç¿»è¨³
                        translateText(transcript);
                        lastProcessedLength = 0;
                    } else {
                        interim = transcript;
                        // éƒ¨åˆ†ç¿»è¨³ã®é–¾å€¤ã‚’è¨€èªã«å¿œã˜ã¦èª¿æ•´ï¼ˆã‚ˆã‚ŠåŠ¹ç‡çš„ã«ï¼‰
                        const threshold = isJaToEn ? 15 : 50; // é–¾å€¤ã‚’ä¸‹ã’ã¦ã‚ˆã‚Šé »ç¹ã«ç¿»è¨³
                        if (interim.length - lastProcessedLength > threshold) {
                            const chunk = interim.substring(lastProcessedLength).trim();
                            if (chunk.length > 3) { // çŸ­ã™ãã‚‹ãƒ†ã‚­ã‚¹ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
                                translateText(chunk);
                                lastProcessedLength = interim.length;
                            }
                        }
                    }
                }
                currentInterimText = interim;
                draw();
            };
            recognition.onend = () => {
                // æ„å›³çš„ãªåœæ­¢ã§ãªã‘ã‚Œã°å†é–‹
                if (isRecognitionActive) {
                    recognition.start();
                } else {
                    startBtn.textContent = 'ğŸ¤ èªè­˜é–‹å§‹';
                    startBtn.className = 'btn btn-green';
                    modeDisplay.innerText = "åœæ­¢ä¸­";
                }
            };
        } else {
            showNotification("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ (Chromeæ¨å¥¨)", "error");
            startBtn.disabled = true;
            startBtn.textContent = "âŒ éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶";
        }

        let isRecognitionActive = false;

        startBtn.onclick = () => {
            if (!recognition) return;

            if (isRecognitionActive) {
                // åœæ­¢å‡¦ç†
                isRecognitionActive = false;
                recognition.stop();
                startBtn.textContent = 'ğŸ¤ èªè­˜é–‹å§‹';
                startBtn.className = 'btn btn-green';
            } else {
                // é–‹å§‹å‡¦ç†
                isRecognitionActive = true;
                recognition.lang = isJaToEn ? 'ja-JP' : 'en-US';
                try {
                    recognition.start();
                    startBtn.textContent = 'â¹ èªè­˜åœæ­¢';
                    startBtn.className = 'btn btn-red';
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–‡å­—ã‚’æ¶ˆã™
                    if (currentTranslatedText === "Subtitle Preview") currentTranslatedText = "";
                    startBtn.style.display = 'inline-block'; // PiPæ™‚ã‚‚ãƒœã‚¿ãƒ³ã¯æ¶ˆã•ãªã„ï¼ˆæ“ä½œã§ãã‚‹ã‚ˆã†ã«ï¼‰

                    video.srcObject = canvas.captureStream(10);
                    video.play().catch(e => console.log("Video play error (background):", e));
                    draw();
                } catch (e) {
                    console.error(e);
                    isRecognitionActive = false;
                    showNotification("èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼", "error");
                }
            }
        };

        // ==========================================
        // LocalStorage Logic
        // ==========================================
        function saveSettings() {
            const settings = {
                gasUrl: cfgGasUrl.value,
                email: cfgEmail.value,
                width: cfgWidth.value,
                height: cfgHeight.value,
                fontSize: cfgFontSize.value,
                textColor: cfgTextColor.value,
                bgColor: cfgBgColor.value,
                bgOpacity: cfgBgOpacity.value,
                showFrame: cfgShowFrame.checked,
                keywords: manualKeywords.value,
                dictionary: myDictionary.value
            };
            localStorage.setItem('classTranslatorSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('classTranslatorSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if (settings.gasUrl) cfgGasUrl.value = settings.gasUrl;
                    if (settings.email) cfgEmail.value = settings.email;
                    if (settings.width) cfgWidth.value = settings.width;
                    if (settings.height) cfgHeight.value = settings.height;
                    if (settings.fontSize) cfgFontSize.value = settings.fontSize;
                    if (settings.textColor) cfgTextColor.value = settings.textColor;
                    if (settings.bgColor) cfgBgColor.value = settings.bgColor;
                    if (settings.bgOpacity) {
                        cfgBgOpacity.value = settings.bgOpacity;
                        bgOpacityValue.textContent = settings.bgOpacity;
                    }
                    if (settings.showFrame !== undefined) {
                        cfgShowFrame.checked = settings.showFrame;
                        if (settings.showFrame) {
                            canvas.classList.remove('no-frame');
                        } else {
                            canvas.classList.add('no-frame');
                        }
                    }
                    if (settings.keywords) manualKeywords.value = settings.keywords;
                    if (settings.dictionary) {
                        myDictionary.value = settings.dictionary;
                        // è¾æ›¸ã‚‚æ›´æ–°ã—ã¦ãŠã
                        saveDictBtn.click();
                    }
                    updateConfig();
                } catch (e) {
                    console.error("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e);
                }
            }
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ã‚‚ã—åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«URLãŒãªã‘ã‚Œã°ã€ä»¥å‰ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤ã‚’ placeholder çš„ã«å…¥ã‚Œã¦ãŠãã®ã‚‚è¦ªåˆ‡ã ãŒ
            // ä»Šå›ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ„è­˜ã§ç©ºã‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ä¿ƒã™å½¢ã«ã™ã‚‹ã€‚
            // ãŸã ã—ã€ä»¥å‰ã®å€¤ã‚’æŒã£ã¦ã‚‹äººãŒã‚¹ãƒ ãƒ¼ã‚ºã«ç§»è¡Œã§ãã‚‹ã‚ˆã†ã«ã€ã‚‚ã—LocalstorageãŒç©ºãªã‚‰
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦æ—§ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤ã‚’å…¥ã‚Œã¦ã‚ã’ã‚‹ï¼ˆä»Šå›ã ã‘ç‰¹åˆ¥æªç½®ã¨ã—ã¦ï¼‰
            if (!saved && !cfgGasUrl.value) {
                cfgGasUrl.value = "https://script.google.com/macros/s/AKfycbwPIYiOJu8Jn-Zke3wylZ2W4_fKMIkeDWGWiJV7LSLf70t9Q5-lacYj2pifcDDgXrYqyA/exec";
                cfgEmail.value = "yutairayu0924@gmail.com";
                saveSettings();
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        loadSettings();

        // PiPåˆ¶å¾¡æ”¹å–„
        pipBtn.onclick = async () => {
            if (!recognition) return;

            // èªè­˜ãŒå§‹ã¾ã£ã¦ã„ãªã„å ´åˆã¯é–‹å§‹ã™ã‚‹
            if (!isRecognitionActive) {
                startBtn.click();
                // èªè­˜é–‹å§‹ã®éåŒæœŸå‡¦ç†ï¼ˆæ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆãªã©ï¼‰ã‚’å¾…ã¤ãŸã‚ã«å°‘ã—é…å»¶ã•ã›ã‚‹
                await new Promise(r => setTimeout(r, 1000));
            }

            try {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ åŒ–ï¼ˆã¾ã ã—ã¦ã„ãªã‘ã‚Œã°ï¼‰
                if (video.srcObject == null || video.srcObject.active === false) {
                    video.srcObject = canvas.captureStream(30); // 30fps
                    await video.play();
                }

                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await video.requestPictureInPicture();
                }
            } catch (e) {
                console.error(e);
                showNotification("PiPã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‹ã‚‰è©¦ã—ã¦ãã ã•ã„", "error");
            }
        };

        // PiPçŠ¶æ…‹ã®ç›£è¦–
        video.onenterpictureinpicture = () => {
            pipBtn.textContent = "ğŸ“º ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤çµ‚äº†";
            showNotification("å­—å¹•ã‚’æœ€å‰é¢ã«è¡¨ç¤ºã—ã¾ã—ãŸ");
        };

        video.onleavepictureinpicture = () => {
            pipBtn.textContent = "ğŸ“º å­—å¹•ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º (PiP)";
        };

        // åˆæœŸæç”»ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
        draw();
    </script>
</body>

</html>