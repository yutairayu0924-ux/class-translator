<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Lecture Subtitle - AI Powered V13</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: #eee; margin: 0; padding: 10px; }
        .setup-container { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; background: #333; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .setup-box { background: #444; padding: 10px; border-radius: 5px; font-size: 0.8rem; text-align: left; }
        .control-panel { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #444; }
        .btn { padding: 10px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; margin: 5px; transition: 0.2s; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #2980b9; color: white; }
        .btn-orange { background: #e67e22; color: white; width: 100%; margin-top: 5px; font-size: 0.8rem; }
        .btn-switch { background: #f39c12; color: white; width: 100%; max-width: 400px; font-size: 1.1rem; }
        textarea { width: 95%; height: 50px; background: #111; color: #0f0; border: 1px solid #555; padding: 5px; font-size: 0.75rem; font-family: monospace; resize: none; }
        .config-input { width: 90%; margin-bottom: 5px; background: #222; color: white; border: 1px solid #666; padding: 4px; }
        .color-picker { height: 30px; width: 100%; cursor: pointer; }
        #canvasContainer { display: flex; justify-content: center; margin-top: 10px; overflow-x: auto; }
        #subtitleCanvas { border: 1px solid #666; background: #000; max-width: 100%; height: auto; }
        #status-bar { font-size: 1rem; font-weight: bold; color: #f1c40f; margin: 5px 0; }
        label { display: block; margin-bottom: 3px; font-weight: bold; color: #ddd; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="setup-container">
    <div class="setup-box">
        <label>1. ç”¨èªå­¦ç¿’ (PDF)</label>
        <input type="file" id="pdfUpload" accept="application/pdf" style="width:100%">
    </div>
    <div class="setup-box">
        <label>2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒã‚¤è¾æ›¸</label>
        <input type="text" id="manualKeywords" class="config-input" placeholder="è£œæ­£: AI, Gemini...">
        <textarea id="myDictionary" placeholder="è¾æ›¸: äººå·¥çŸ¥èƒ½:AI"></textarea>
        <button id="saveDictBtn" class="btn btn-orange">è¾æ›¸ç¢ºå®š</button>
    </div>
    <div class="setup-box">
        <label>3. ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š</label>
        å¹…: <input type="number" id="cfgWidth" class="config-input" value="1900">
        é«˜ã•: <input type="number" id="cfgHeight" class="config-input" value="150">
        æ–‡å­—ã‚µã‚¤ã‚º: <input type="number" id="cfgFontSize" class="config-input" value="50">
    </div>
    <div class="setup-box">
        <label>4. è‰²è¨­å®š</label>
        æ–‡å­—è‰²: <input type="color" id="cfgTextColor" class="color-picker" value="#ffffff">
        èƒŒæ™¯è‰²: <input type="color" id="cfgBgColor" class="color-picker" value="#000000">
    </div>
</div>

<div class="control-panel">
    <div id="status-bar">ãƒ¢ãƒ¼ãƒ‰: <span id="modeDisplay">æº–å‚™ä¸­</span></div>
    <button id="toggleLang" class="btn btn-switch">ğŸ”„ è¨€èªã‚’å…¥ã‚Œæ›¿ãˆã‚‹</button>
    <br>
    <button id="startBtn" class="btn btn-green">ğŸ¤ èªè­˜é–‹å§‹</button>
    <button id="pipBtn" class="btn btn-blue" style="display:none;">ğŸ“º å­—å¹•ã‚’æµ®ã‹ã›ã‚‹ (PiP)</button>
</div>

<div id="canvasContainer">
    <canvas id="subtitleCanvas" width="1900" height="150"></canvas>
</div>
<video id="videoElement" autoplay playsinline muted style="display:none;"></video>

<script>
    // ========================================================
    // ã€é‡è¦ã€‘ã“ã“ã«Google AI Studioã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ã‚’å…¥ã‚Œã‚‹
    const GEMINI_API_KEY = "AIzaSyAQTCsmpRCG0WDcQ6WAdGicYlNz9RrdRMw"; 
    // ========================================================

    const startBtn = document.getElementById('startBtn');
    const pipBtn = document.getElementById('pipBtn');
    const toggleLang = document.getElementById('toggleLang');
    const modeDisplay = document.getElementById('modeDisplay');
    const manualKeywords = document.getElementById('manualKeywords');
    const myDictionary = document.getElementById('myDictionary');
    const saveDictBtn = document.getElementById('saveDictBtn');
    const pdfUpload = document.getElementById('pdfUpload');
    const canvas = document.getElementById('subtitleCanvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('videoElement');
    
    // è¨­å®šUI
    const cfgWidth = document.getElementById('cfgWidth');
    const cfgHeight = document.getElementById('cfgHeight');
    const cfgFontSize = document.getElementById('cfgFontSize');
    const cfgTextColor = document.getElementById('cfgTextColor');
    const cfgBgColor = document.getElementById('cfgBgColor');

    let recognition;
    let isJaToEn = true; 
    let currentTranslatedText = "AI Translation Ready";
    let currentInterimText = "";
    let glossary = [];
    let activeDictionary = [];
    let lastProcessedLength = 0;

    // è¨­å®šåæ˜ 
    function updateConfig() {
        canvas.width = parseInt(cfgWidth.value) || 1900;
        canvas.height = parseInt(cfgHeight.value) || 150;
        draw();
    }
    cfgWidth.onchange = updateConfig;
    cfgHeight.onchange = updateConfig;
    cfgFontSize.onchange = draw;
    cfgTextColor.oninput = draw;
    cfgBgColor.oninput = draw;

    updateModeDisplay();

    saveDictBtn.onclick = () => {
        const lines = myDictionary.value.split('\n');
        activeDictionary = [];
        lines.forEach(line => {
            const [src, target] = line.split(/[:ï¼š]/);
            if (src && target) activeDictionary.push({ src: src.trim(), target: target.trim() });
        });
        alert(`è¾æ›¸æ›´æ–°å®Œäº† (${activeDictionary.length}ä»¶)`);
    };

    toggleLang.onclick = () => {
        isJaToEn = !isJaToEn;
        updateModeDisplay();
        if (recognition) {
            recognition.stop();
            recognition.lang = isJaToEn ? 'ja-JP' : 'en-US';
        }
    };

    function updateModeDisplay() {
        modeDisplay.innerText = isJaToEn ? "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª â†’ ğŸ‡ºğŸ‡¸ è‹±èª (AI)" : "ğŸ‡ºğŸ‡¸ è‹±èª â†’ ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª (AI)";
    }

    pdfUpload.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(' ');
            }
            glossary = [...new Set([...glossary, ...(fullText.match(/[A-Z]{2,}|[a-zA-Z]{4,}|[\u4e00-\u9faf]{2,}/g) || [])])];
            alert("PDFå­¦ç¿’å®Œäº†ï¼");
        };
        reader.readAsArrayBuffer(file);
    };

    // â˜…Gemini APIã‚’å‘¼ã³å‡ºã™é–¢æ•°
    async function translateText(text) {
        if (!text.trim()) return;

        // æ‰‹å‹•ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å–å¾—
        const manual = manualKeywords.value.split(/[,ã€\s\n]+/).filter(w => w.length > 0);
        const activeGlossary = [...new Set([...glossary, ...manual])];
        
        // è¨€èªè¨­å®š
        const targetLang = isJaToEn ? "English" : "Japanese";
        const sourceLang = isJaToEn ? "Japanese" : "English";

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAIã¸ã®å‘½ä»¤æ›¸ï¼‰ã®ä½œæˆ
        const prompt = `
        You are a professional simultaneous interpreter.
        Translate the following ${sourceLang} text to ${targetLang}.
        
        Rules:
        1. Context: This is a university lecture or presentation.
        2. Correction: If the input seems like a speech recognition error, guess the correct meaning from context and translate it.
        3. Keywords: Prioritize these terms if relevant: [${activeGlossary.join(', ')}].
        4. Output: Return ONLY the translated text. No explanations.
        
        Input: "${text}"
        `;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });
            
            const data = await response.json();
            let translated = data.candidates[0].content.parts[0].text.trim();

            // ãƒã‚¤è¾æ›¸ã®é©ç”¨ï¼ˆæœ€çµ‚å¼·åˆ¶ä¸Šæ›¸ãï¼‰
            activeDictionary.forEach(pair => {
                const regex = new RegExp(pair.src, 'gi');
                translated = translated.replace(regex, pair.target);
            });

            currentTranslatedText = translated;
            draw();
        } catch (e) {
            console.error("Gemini API Error:", e);
        }
    }

    function draw() {
        ctx.fillStyle = cfgBgColor.value;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (currentInterimText) {
            ctx.fillStyle = '#888888'; 
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(currentInterimText, 10, 15);
        }

        const maxWidth = canvas.width - 50;
        let baseSize = parseInt(cfgFontSize.value) || 50;
        let fontSize = baseSize; 
        let lineHeight = baseSize * 1.2;

        if (currentTranslatedText.length > 100) { fontSize = baseSize * 0.6; lineHeight = fontSize * 1.2; }
        else if (currentTranslatedText.length > 60) { fontSize = baseSize * 0.8; lineHeight = fontSize * 1.2; }

        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.fillStyle = cfgTextColor.value;
        ctx.textAlign = 'center';

        let words = currentTranslatedText.split('');
        let lines = [];
        let currentLine = words[0] || "";

        for (let i = 1; i < words.length; i++) {
            let width = ctx.measureText(currentLine + words[i]).width;
            if (width < maxWidth) {
                currentLine += words[i];
            } else {
                lines.push(currentLine);
                currentLine = words[i];
            }
        }
        lines.push(currentLine);

        let totalHeight = lines.length * lineHeight;
        let startY = (canvas.height - totalHeight) / 2 + (lineHeight / 2) - 5; 

        for (let i = 0; i < lines.length; i++) {
            ctx.fillText(lines[i], canvas.width / 2, startY + (i * lineHeight));
        }
    }

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = async (event) => {
            let interim = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                let transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    translateText(transcript);
                    lastProcessedLength = 0;
                } else {
                    interim = transcript;
                    // AIã¯å°‘ã—é•·ã‚ã®æ–‡è„ˆãŒã‚ã£ãŸã»ã†ãŒè³¢ã„ã®ã§ã€é–¾å€¤ã‚’å°‘ã—é•·ã‚ã«è¨­å®š
                    const threshold = isJaToEn ? 40 : 120;
                    if (interim.length - lastProcessedLength > threshold) {
                        const chunk = interim.substring(lastProcessedLength);
                        translateText(chunk);
                        lastProcessedLength = interim.length;
                    }
                }
            }
            currentInterimText = interim;
            draw();
        };
        recognition.onend = () => { recognition.start(); };
    }

    startBtn.onclick = () => {
        recognition.lang = isJaToEn ? 'ja-JP' : 'en-US';
        recognition.start();
        if(currentTranslatedText === "AI Translation Ready") currentTranslatedText = ""; 
        startBtn.style.display = 'none';
        pipBtn.style.display = 'inline-block';
        video.srcObject = canvas.captureStream(10);
        video.play();
        draw();
    };
    pipBtn.onclick = () => video.requestPictureInPicture();
    
    draw();
</script>
</body>
</html>